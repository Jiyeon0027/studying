# Chapter 5. 프로그램 내에서 코드로 카프카 관리하기

- `AdminClient`: 카프카의 프로그램적인 관리 기능 api를 제공하기 위한 목적

## 5.1 AdminClient 개요

### 5.1.1 비동기적이고 최종적 일관성을 가지는 api

<mark>비동기적</mark>으로 작동하는 AdminClient

- 각 메서드는 요청을 클러스터 컨트롤러로 전송한 뒤 바로 1개 이상의 Future객체를 리턴
- Future객체는 컨트롤러의 상태가 완전히 업데이트된 시점에서 완료된 것으로 간주됨 - `최종적 일관성`
- 언젠가는 최종적으로 모든 브로커는 모든 토픽에 대해 알게 되지만 언제인지는 보장하지 않음

### 5.1.2 옵션

- 각 메서드는 메서드별로 특정한 옵션 객체들을 받음 : ex. listTopics 메서드는 ListTopicsOptions 객체를 인수로 받음
- 모든 메서드가 동일하게 가지고 있는 매개변수 : timeoutMs

### 5.1.3 수평구조

- 모든 어드민 작업은 KafkaAdminClient 에 구현되어 있는 아파치 카프카 프로토콜을 사용해 이루어짐.
- 인터페이스가 크다는 단점. 메서드만 찾아서 쓰고 자동완성이 가능한 장점.

### 추가 참고사항

- 클라이언트의 상태를 변경하는 모든 작업은 컨트롤러에 의해 수행
- 클러스터의 상태를 읽기만 하는 작업은 아무 브로커에서 수행 가능

## 5.2 AdminClient 사용법 : 생성, 설정, 닫기

```java
Properties props = new Properties();
props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
AdminClient adminClient = AdminClient.create(props);
//TODO : AdminClient 사용
adminClient.close();
```

- create 메서드로 설정값을 담는 Properties 객체를 인수로 받음
- close 메서드는 타임아웃 매개변수를 받고 모든 진행중인 작업이 완료될때 까지 대기

### `client.dns.lookup`

- 보통은 부트스트랩 서버의 설정된 호스트명을 기준으로 연결을 검증하고 해석하고 생성
- 두가지 예외

1. DNS 별칭 alias를 사용하는 경우

   - 별칭이 있는 경우에 SASL의 인증에서 문제가 생김- 보안의 주체가 별칭과 다르기 때문
   - `client.dns.lookup=resolve_canonical_bootstrap_servers_only` -> 별칭을 펼쳐주는 역할

2. 다수의 IP주소로 연결되는 DNS이름을 사용하는 경우
   - 로드밸런서를 두어서 여러IP를 두는 경우
   - 클라이언트가 로드밸런싱 계층의 고가용성을 충분히 이용할 수 있게 설정
   - `client.dns.lookup=use_all_dns_ips`

### `request.timeout.ms`

- 애플리케이션이 AdminClient의 응답을 기다릴수 있는 시간의 최댓값을 정의
- 재시도가 가능한 에러를 받고 재시도 하는 시간이 포함

## 5.3 필수적인 토픽 관리 기능

```java
ListTopicsResults topics = admin.listTopics(); //Future객체들을 감싸고 있는 ListTopicsResults 객체 리턴
Set<String> topicNames = topics.names().get();
for (String topicName : topicNames) {
    System.out.println(topicName);
}
```

- 원하는 토픽이 있는지 확인하고 없으면 생성해보자
  - 설정 토픽을 확인하기
    - 하나의 파티션을 갖는다. 이것을 설정 변경에 온전한 순서를 부여하기 위해 필요
    - 가용성을 보장하기 위해 3개의 레플리카
    - 설정 토픽 오래된 설정 값도 계속해서 저장되도록 토픽에 압착설정이 되어있음

```java
DescribeTopicsResult demoTopic = admin.describeTopics(TOPICE_LIST);

try{
    topicDescription = demoTopic.values().get(TOPIC_NAME).get();
    System.out.printIn("Description of demo topic : " + topicDescription.toString);

    if(topicDescription.partitions().size() != NUM_PARTITIONS){
        System.out.printIn("Topic has wrong Number of patitions");
        System.exit(1);

    }
}catch(ExecutionException e){
    if(e.getCause() instanceof UnknownTopicOrPartitionException){
        e.printStackTrace();
        throw e;
    }

    System.out.printIn("Topic " + TOPIC_NAME + "does not exists. Create!!!");

    CreateTopicsResult newTopic = admin.createTopics(Collections.singletonList(
        new NewTopic(TOPIC_NAME, NUM_PARTITIONS, REPLICATION_FACTOR)
    ));

    if(newTopic.all().get() != null){
        System.out.printIn("Topic has wrong Number of patitions");
        System.exit(1);
    }
}
```
