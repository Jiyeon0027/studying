# Chapter 4. 카프카 컨슈머 : 카프카에서 데이터 읽기

- 토픽을 구독하고 구독한 토픽들로부터 메시지를 받기 위해 `KafkaConsumer`사용

## 4.1 카프카 컨슈머 : 개념

### 컨슈머와 컨슈머 그룹

- 컨슈머 객체를 생성 -> 해당 토픽 구독 -> 메시지를 받아 검사하고 결과를 써야함
- 만약 더 빠른 속도로 토픽에 메시지를 프로듀서가 쓴다면?
  - 컨슈머의 갯수를 확장하여 분할해서 데이터를 읽어와야 함
  - 이를 위해 컨슈머 그룹의 일부로 `카프카 컨슈머`가 동작

<img src="https://velog.velcdn.com/images/tngus3722/post/31de66de-f6f9-4fbd-aeaa-03e821117d49/image.png" alt="카프카 컨슈머 그룹 2" width="300" style="display: block; margin: 0 auto;"><br>

- 컨슈머 그룹에 파티션 수보다 많은 컨슈머를 추가하여 `유휴상태`가 되어 메시지를 받지 못하는 모습

<img src="https://velog.velcdn.com/images/tngus3722/post/7346e2b6-b267-4de2-93ad-0dc392d04c3c/image.png" alt="카프카 컨슈머 그룹 5" width="300" style="display: block; margin: 0 auto;" >

- **컨슈머 추가**: DB 저장 등 지연이 긴 작업으로 인해 일반적으로 컨슈머를 추가하여 분산 처리
- **컨슈머 그룹**: 여러 애플리케이션이 한 토픽을 사용할 때 각각 다른 컨슈머 그룹 생성
  - 성능 저하 없이 카프카 활용 가능

<img src="https://velog.velcdn.com/images/tngus3722/post/5cd2abdc-9c0c-4caf-8737-b7e04fcbed22/image.png" alt="카프카 컨슈머 그룹 5" width="300" style="display: block; margin: 0 auto;" >

### 컨슈머 그룹과 파티션 리벨런스

- 컨슈머 그룹에 컨슈머가 추가되거나 종료되면?

  - 컨슈머에 파티션을 재할당 받아야 함 (`리밸런스`)
  - 따라서 컨슈머들은 토픽의 파티션들에 대한 소유권을 공유
  - `높은 가용성`과 `규모 가변성` 제공

- 조급한 리밸런스 eager rebalance
  - **모든** 컨슈머가 읽기 작업을 멈추고 소유권을 포기 -> 다시 참여 join 후 파티션을 할당 받음
  - 작업이 멈추는 단점
- 협력적 리밸런스 cooperative rebalance

  - 한 컨슈머에게 할당 되어 있던 파티션만을 다른 컨슈머에 재할당
  - 순서
    1. 컨슈머 그룹 리더가 재할당 될것임을 다른 컨슈머에게 통보
    2. 통보받은 컨슈머는 작업을 멈추고 소유권 포기
    3. 새로 할당
  - 장점 : 멈추지 않고 점진적으로 할당 가능

- 어떻게 컨슈머 리밸런싱 시작하는가?
  - 각 컨슈머들은 그룹 코디네이터 역할을 지정받은 해당 컨슈머 그룹의 카프카 브로커에 하트비트를 전송
  - 이를 통해 멤버십과 할당된 파티션에 대한 소유권을 유지
    <img src="https://i.ibb.co/S4rX0q62/image.png" alt="카프카 컨슈머 그룹 5" width="80%" style="display: block; margin: 0" >
  - 만약 하트비트가 전송되지 않으면 죽었다고 판단후 리밸런스 진행

### 정적 그룹 멤버십

- 보통 컨슈머가 갖는 컨슈머 그룹의 멤버로의 자격 : 일시적
- `group.instance.id` 값을 설정하면 정적그룹 멤버십으로 변경되고 컨슈머가 꺼져도 참여할때 다시 파티션을 재할당 받아서 유지 가능
- 컨슈머에 할당된 파티션의 내용물을 사용해서 로컬 상태나 캐시를 유지해야할 때 편리
- 정적멤버의 종료 : `session.timeout.ms`

## 4.2 카프카 컨슈머 생성하기

```java
Properties props = new Properties();
props.put("bootstrap.servers", "broker1:9092,broker2:9092");
props.put("group.id", "CountryCounter");
props.put("key.deserializer",
        "org.apache.kafka.common.serialization.StringDeserializer");
props.put("value.deserializer",
        "org.apache.kafka.common.serialization.StringDeserializer");

KafkaConsumer<String, String> consumer = new KafkaConsumer<String, String>(props);
```

- `KafkaConsumer` 인스턴스 생성
- `bootstrap.servers`, `key.deserializer`, `value.deserializer` 지정
- 새로 추가된 속성 : `group.id`- 컨슈머가 속하는 컨슈머 그룹 id를 지정

## 4.3 토픽 구독하기

- 단순히 하나의 토픽이름으로 목록을 생성

```java
consumer.subscribe(Collections.singletonList("customerCountries"));
```

- 정규식을 이용해서 subscribe 하는것도 가능 : 이에 해당하는 토픽에 즉시 리밸런스가 발생

```java
consumer.subscribe(Pattern.compile("test.\*"));
```
